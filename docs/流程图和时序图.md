# FastGateway 系统流程图和时序图

## 目录
- [1. 系统架构图](#1-系统架构图)
- [2. 连接建立流程图](#2-连接建立流程图)
- [3. 请求处理时序图](#3-请求处理时序图)
- [4. 隧道创建流程图](#4-隧道创建流程图)
- [5. 数据流转图](#5-数据流转图)
- [6. 心跳保活时序图](#6-心跳保活时序图)
- [7. 错误处理流程图](#7-错误处理流程图)

## 1. 系统架构图

```mermaid
graph TB
    subgraph "互联网"
        Client[外部客户端]
    end

    subgraph "公网服务器"
        Gateway[FastGateway主服务]
        subgraph "Gateway组件"
            Router[路由器]
            TunnelMgr[隧道管理器]
            Auth[认证服务]
            SSL[SSL证书管理]
        end
    end

    subgraph "内网环境"
        TunnelClient[TunnelClient客户端]
        subgraph "Client组件"
            Monitor[连接监控]
            Proxy[YARP代理]
            LocalSvc[本地服务]
        end
    end

    Client -->|HTTPS请求| Gateway
    Gateway --> Router
    Router --> TunnelMgr
    TunnelMgr -->|HTTP/2或WebSocket隧道| Monitor
    Monitor --> Proxy
    Proxy --> LocalSvc
    
    Auth -.->|Token验证| TunnelMgr
    SSL -.->|证书选择| Gateway
```

## 2. 连接建立流程图

```mermaid
flowchart TD
    Start([TunnelClient启动]) --> LoadConfig[加载tunnel.json配置]
    LoadConfig --> CreateYARP[创建YARP反向代理配置]
    CreateYARP --> StartLocal[启动本地代理服务]
    StartLocal --> Register[向服务器注册节点]
    
    Register --> PostRegister{POST /internal/gateway/Server/register}
    PostRegister -->|Token验证失败| AuthFail[认证失败，退出]
    PostRegister -->|验证成功| SaveConfig[服务器保存客户端配置]
    
    SaveConfig --> CreateMain[创建主连接]
    CreateMain --> SelectProtocol{选择协议}
    SelectProtocol -->|HTTP/2| HTTP2Connect[HTTP/2 CONNECT连接]
    SelectProtocol -->|WebSocket| WSConnect[WebSocket连接]
    
    HTTP2Connect --> CreateAgent[创建AgentClientConnection]
    WSConnect --> CreateAgent
    
    CreateAgent --> StartHeartbeat[启动心跳机制]
    StartHeartbeat --> Listen[监听隧道ID]
    Listen --> Ready[准备接收请求]
    
    Ready -->|连接断开| Reconnect[等待重连]
    Reconnect --> Register
```

## 3. 请求处理时序图

```mermaid
sequenceDiagram
    participant Client as 外部客户端
    participant Gateway as FastGateway
    participant Router as 路由器
    participant TunnelMgr as 隧道管理器
    participant Agent as AgentClient
    participant TClient as TunnelClient
    participant LocalSvc as 内网服务

    Client->>Gateway: HTTPS请求
    Gateway->>Router: 路由解析
    Router->>Router: 匹配域名和路径
    Router->>TunnelMgr: 查找对应TunnelClient
    
    TunnelMgr->>TunnelMgr: 生成tunnelId
    Note over TunnelMgr: UUID.NewGuid()
    
    TunnelMgr->>Agent: 发送tunnelId
    Agent->>TClient: 通过主连接通知
    Note over Agent,TClient: "tunnelId\r\n"
    
    TClient->>TClient: 创建到服务器的隧道连接
    TClient->>LocalSvc: 连接本地服务端口
    LocalSvc-->>TClient: 连接建立成功
    
    TClient->>Agent: 隧道连接建立完成
    Agent->>Gateway: 隧道就绪
    
    Note over Client,LocalSvc: 开始双向数据传输
    Client->>Gateway: 请求数据
    Gateway->>Agent: 转发请求
    Agent->>TClient: 通过隧道传输
    TClient->>LocalSvc: 转发到本地服务
    
    LocalSvc-->>TClient: 响应数据
    TClient-->>Agent: 通过隧道返回
    Agent-->>Gateway: 返回响应
    Gateway-->>Client: 最终响应
```

## 4. 隧道创建流程图

```mermaid
flowchart TD
    Request[外部请求到达] --> RouteMatch[路由匹配]
    RouteMatch --> FindClient{查找TunnelClient}
    FindClient -->|未找到| Return404[返回404错误]
    FindClient -->|找到| GenTunnelId[生成隧道ID]
    
    GenTunnelId --> SendId[发送隧道ID到客户端]
    SendId --> WaitClient[等待客户端建立隧道]
    
    WaitClient --> ClientReceive[客户端接收隧道ID]
    ClientReceive --> CreateServerTunnel[创建到服务器的隧道连接]
    CreateServerTunnel --> CreateLocalTunnel[创建到本地服务的连接]
    
    CreateLocalTunnel --> CheckLocal{本地服务可用?}
    CheckLocal -->|不可用| LocalError[本地连接失败]
    CheckLocal -->|可用| BindTunnel[绑定隧道IO]
    
    BindTunnel --> StartCopy[启动双向数据复制]
    StartCopy --> Server2Local[服务器->本地数据流]
    StartCopy --> Local2Server[本地->服务器数据流]
    
    Server2Local --> WaitComplete[等待传输完成]
    Local2Server --> WaitComplete
    
    WaitComplete --> Cleanup[清理资源]
    LocalError --> Cleanup
    Cleanup --> End([隧道关闭])
```

## 5. 数据流转图

```mermaid
graph LR
    subgraph "外部请求流"
        ExtReq[外部HTTP请求] --> GW[Gateway路由器]
        GW --> TM[隧道管理器]
        TM --> Agent[AgentClient]
    end
    
    subgraph "隧道传输层"
        Agent --> ST[ServerTunnel]
        ST -.->|HTTP/2 或 WebSocket| CT[ClientTunnel]
        CT --> TC[TunnelClient]
    end
    
    subgraph "内网服务流"
        TC --> LP[本地代理]
        LP --> LS[内网服务]
    end
    
    subgraph "响应流"
        LS --> LP2[本地代理响应]
        LP2 --> TC2[TunnelClient响应]
        TC2 --> CT2[ClientTunnel响应]
        CT2 -.->|隧道返回| ST2[ServerTunnel响应]
        ST2 --> Agent2[AgentClient响应]
        Agent2 --> GW2[Gateway响应]
        GW2 --> ExtResp[外部HTTP响应]
    end
    
    style ST fill:#e1f5fe
    style CT fill:#e1f5fe
    style ST2 fill:#fff3e0
    style CT2 fill:#fff3e0
```

## 6. 心跳保活时序图

```mermaid
sequenceDiagram
    participant Server as AgentClientConnection
    participant Client as TunnelClient
    
    Note over Server,Client: 连接建立后启动心跳机制
    
    loop 心跳循环
        Server->>Client: PING\r\n
        Note over Server: Timer触发，每30秒
        
        Client->>Server: PONG\r\n
        Note over Client: 收到PING后立即响应
        
        Note over Server: 确认客户端存活
    end
    
    Note over Server,Client: 如果超时未收到PONG
    Server->>Server: 检测超时
    Server->>Server: 关闭连接
    Server->>Server: 清理资源
    
    Note over Client: 客户端也可发起心跳
    Client->>Server: PING\r\n
    Server->>Client: PONG\r\n
```

## 7. 错误处理流程图

```mermaid
flowchart TD
    Start([连接开始]) --> TryConnect[尝试建立连接]
    TryConnect --> CheckAuth{Token验证}
    CheckAuth -->|失败| AuthError[认证错误]
    CheckAuth -->|成功| Connected[连接成功]
    
    AuthError --> Delay5s[延迟5秒]
    Delay5s --> Exit[退出程序]
    
    Connected --> Monitor[监控连接状态]
    Monitor --> CheckError{检测错误}
    
    CheckError -->|网络错误| NetworkError[网络连接错误]
    CheckError -->|超时| TimeoutError[超时错误]
    CheckError -->|IO错误| IOError[IO异常]
    CheckError -->|正常| Continue[继续监控]
    
    NetworkError --> LogError[记录错误日志]
    TimeoutError --> LogError
    IOError --> LogError
    
    LogError --> WaitReconnect[等待重连间隔]
    WaitReconnect --> TryConnect
    
    Continue --> Monitor
    
    subgraph "隧道级别错误处理"
        TunnelError[隧道传输错误] --> TunnelLog[记录隧道错误]
        TunnelLog --> CleanTunnel[清理隧道资源]
        CleanTunnel --> DecrementCount[减少隧道计数]
    end
```

## 8. 完整系统交互图

```mermaid
graph TB
    subgraph "外部网络"
        Browser[浏览器]
        Mobile[移动应用]
        API[API客户端]
    end
    
    subgraph "FastGateway服务端" 
        LB[负载均衡器]
        GW1[Gateway实例1]
        GW2[Gateway实例2]
        
        subgraph "核心组件"
            Router[路由管理]
            TunnelFactory[隧道工厂]
            AgentMgr[Agent管理器]
            CertMgr[证书管理]
        end
        
        subgraph "中间件管道"
            Auth[认证中间件]
            RateLimit[限流中间件]
            Blacklist[黑名单中间件]
        end
    end
    
    subgraph "内网环境1"
        TC1[TunnelClient1]
        Web1[Web服务1]
        DB1[数据库1]
    end
    
    subgraph "内网环境2"
        TC2[TunnelClient2]
        API2[API服务2]
        File2[文件服务2]
    end
    
    Browser --> LB
    Mobile --> LB
    API --> LB
    
    LB --> GW1
    LB --> GW2
    
    GW1 --> Router
    GW2 --> Router
    Router --> TunnelFactory
    TunnelFactory --> AgentMgr
    
    Auth -.-> GW1
    RateLimit -.-> GW1
    Blacklist -.-> GW1
    
    AgentMgr -.->|HTTP/2隧道| TC1
    AgentMgr -.->|WebSocket隧道| TC2
    
    TC1 --> Web1
    TC1 --> DB1
    TC2 --> API2
    TC2 --> File2
    
    CertMgr -.-> GW1
    CertMgr -.-> GW2
```

## 9. 性能监控图

```mermaid
graph TD
    subgraph "性能指标收集"
        QPS[QPS统计]
        Latency[延迟监控]
        Throughput[吞吐量监控]
        TunnelCount[隧道数量]
    end
    
    subgraph "系统资源"
        CPU[CPU使用率]
        Memory[内存使用]
        Network[网络带宽]
        Disk[磁盘IO]
    end
    
    subgraph "业务指标"
        ActiveUsers[活跃用户]
        ErrorRate[错误率]
        SuccessRate[成功率]
        ResponseTime[响应时间]
    end
    
    QPS --> Dashboard[监控面板]
    Latency --> Dashboard
    Throughput --> Dashboard
    TunnelCount --> Dashboard
    
    CPU --> SystemMonitor[系统监控]
    Memory --> SystemMonitor
    Network --> SystemMonitor
    Disk --> SystemMonitor
    
    ActiveUsers --> BusinessMonitor[业务监控]
    ErrorRate --> BusinessMonitor
    SuccessRate --> BusinessMonitor
    ResponseTime --> BusinessMonitor
    
    Dashboard --> Alert[告警系统]
    SystemMonitor --> Alert
    BusinessMonitor --> Alert
```

## 10. 部署架构图

```mermaid
graph TB
    subgraph "云服务提供商"
        subgraph "公网区域"
            ELB[弹性负载均衡]
            subgraph "多可用区部署"
                AZ1[可用区1]
                AZ2[可用区2]
                GW1[Gateway服务1]
                GW2[Gateway服务2]
            end
        end
        
        subgraph "存储服务"
            RDS[关系数据库]
            Redis[缓存服务]
            OSS[对象存储]
        end
    end
    
    subgraph "企业内网1"
        TC1[TunnelClient1]
        subgraph "内网服务集群1"
            Web1[Web应用]
            API1[API服务]
            DB1[数据库]
        end
    end
    
    subgraph "企业内网2"
        TC2[TunnelClient2]
        subgraph "内网服务集群2"
            ERP[ERP系统]
            CRM[CRM系统]
            OA[OA系统]
        end
    end
    
    Internet[互联网] --> ELB
    ELB --> AZ1
    ELB --> AZ2
    AZ1 --> GW1
    AZ2 --> GW2
    
    GW1 --> RDS
    GW2 --> RDS
    GW1 --> Redis
    GW2 --> Redis
    GW1 --> OSS
    GW2 --> OSS
    
    GW1 -.->|加密隧道| TC1
    GW2 -.->|加密隧道| TC2
    
    TC1 --> Web1
    TC1 --> API1
    TC1 --> DB1
    
    TC2 --> ERP
    TC2 --> CRM
    TC2 --> OA
```

这些Mermaid图表详细展示了FastGateway系统的各个方面，包括架构设计、数据流转、时序交互、错误处理等核心流程，为理解系统提供了直观的可视化参考。